# Руководство по загрузке аватарок

## Обзор

Система загрузки аватарок теперь интегрирована с API `api/users/change_image/`. Пользователи могут загружать изображения через интерфейс настроек, и они будут автоматически сохраняться на сервере.

## API Endpoints

### 1. Загрузка файла изображения
- **URL**: `/api/upload/image`
- **Метод**: `POST`
- **Content-Type**: `multipart/form-data`
- **Параметры**: `file` (File) - файл изображения

### 2. Обновление аватарки (расширенный)
- **URL**: `/api/auth/update-avatar`
- **Метод**: `POST`
- **Поддерживает два типа запросов**:
  - `application/json` с `avatar` (URL строки)
  - `multipart/form-data` с `file` (файл изображения)

## Ограничения

- **Тип файла**: Только изображения (image/*)
- **Максимальный размер**: 1MB
- **Максимальное разрешение**: 1920x1080 пикселей
- **Поддерживаемые форматы**: JPG, PNG, GIF
- **Автоматическое изменение размера**: Если разрешение больше 1920x1080, изображение автоматически уменьшается

## Использование в коде

### Загрузка файла через AuthContext

```typescript
import { useAuth } from '@/context/AuthContext';

function MyComponent() {
  const { uploadAvatarFile } = useAuth();
  
  const handleFileUpload = async (file: File) => {
    try {
      await uploadAvatarFile(file);
      console.log('Аватарка успешно загружена');
    } catch (error) {
      console.error('Ошибка загрузки:', error);
    }
  };
}
```

### Загрузка через AuthApi

```typescript
import { AuthApi } from '@/lib/services/authApi';

// Загрузка файла
const response = await AuthApi.uploadAvatarFile(file);

// Обновление по URL
const response = await AuthApi.updateAvatar(avatarUrl);
```

## Интеграция с настройками

Страница настроек (`/main/site-settings`) теперь поддерживает:

1. **Выбор файла**: Пользователь может выбрать изображение через input[type="file"]
2. **Предварительный просмотр**: Изображение отображается сразу после выбора
3. **Валидация**: Проверка типа и размера файла
4. **Загрузка на сервер**: Файл отправляется на API при нажатии "Сохранить"
5. **Обработка ошибок**: Отображение ошибок пользователю

## Обработка ошибок

Система обрабатывает следующие ошибки:

- Неверный тип файла
- Превышение размера файла (более 1MB)
- Превышение разрешения изображения (более 1920x1080) - автоматически уменьшается
- Ошибки сети
- Ошибки сервера
- Неавторизованный доступ

## Синхронизация

После успешной загрузки аватарка автоматически:

1. Обновляется в `AuthContext`
2. Сохраняется в `localStorage`
3. Синхронизируется между вкладками браузера
4. Отображается во всех компонентах приложения

## Безопасность

- Все запросы требуют авторизации
- Файлы проверяются на тип и размер
- Поддерживается как cookie, так и token аутентификация
- CORS настроен для безопасной загрузки
